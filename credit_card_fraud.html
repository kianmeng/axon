<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.29.3">
    <meta name="project" content="Axon v0.6.0">

    <title>Classifying fraudulent transactions — Axon v0.6.0</title>
    <link rel="stylesheet" href="dist/html-elixir-MB5C7R66.css" />


    <script src="dist/handlebars.runtime-NWIB6V2M.js"></script>
    <script src="dist/handlebars.templates-XRYTXUVD.js"></script>
    <script src="dist/sidebar_items-78464301.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/html-EHGDP2LQ.js"></script>


  </head>
  <body data-type="extras" class="page-livemd">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="main">

<button class="sidebar-button sidebar-toggle" aria-label="toggle sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<section class="sidebar">
  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button" aria-label="Submit Search">
      <i class="ri-search-2-line" aria-hidden="true" title="Submit search"></i>
    </button>
    <button type="button" tabindex="-1" class="search-close-button" aria-label="Cancel Search">
      <i class="ri-close-line ri-lg" aria-hidden="true" title="Cancel search"></i>
    </button>
    <label class="search-label">
      <p class="sr-only">Search</p>
      <input name="q" type="text" class="search-input" placeholder="Search..." aria-label="Input your search terms" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
    </label>
  </form>

  <div class="autocomplete">
    <div class="autocomplete-results">
    </div>
  </div>

  <div class="sidebar-header">

      <a href="Axon.html">
        <img src="assets/logo.png" alt="Axon" class="sidebar-projectImage">
      </a>

    <div class="sidebar-projectDetails">
      <a href="Axon.html" class="sidebar-projectName" translate="no">
Axon
      </a>
      <strong class="sidebar-projectVersion" translate="no">
        v0.6.0
      </strong>
    </div>
    <ul class="sidebar-listNav">
      <li><a id="extras-list-link" href="#full-list">Pages</a></li>

        <li><a id="modules-list-link" href="#full-list">Modules</a></li>


    </ul>
  </div>

  <div class="gradient"></div>
  <ul id="full-list"></ul>
</section>

<section class="content">
  <output role="status" id="toast"></output>
  <div class="content-outer">
    <div id="content" class="content-inner">

<h1>
<button class="icon-action display-settings">
  <i class="ri-settings-3-line"></i>
  <span class="sr-only">Settings</span>
</button>


    <a href="https://github.com/elixir-nx/axon/blob/v0.6.0/notebooks/structured/credit_card_fraud.livemd#L1" title="View Source" class="icon-action" rel="help">
      <i class="ri-code-s-slash-line" aria-hidden="true"></i>
      <span class="sr-only">View Source</span>
    </a>


  <span>Classifying fraudulent transactions</span>
</h1>

  <div class="livebook-badge-container">
    <a href="#" class="livebook-badge">
      <img src="https://livebook.dev/badge/v1/blue.svg" alt="Run in Livebook" width="150" />
    </a>
  </div>

<pre><code class="makeup elixir" translate="no"><span class="nc">Mix</span><span class="o">.</span><span class="n">install</span><span class="p" data-group-id="8445711274-1">(</span><span class="p" data-group-id="8445711274-2">[</span><span class="w">
  </span><span class="p" data-group-id="8445711274-3">{</span><span class="ss">:axon</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.3.0&quot;</span><span class="p" data-group-id="8445711274-3">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="8445711274-4">{</span><span class="ss">:nx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.4.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">override</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="8445711274-4">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="8445711274-5">{</span><span class="ss">:exla</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.4.0&quot;</span><span class="p" data-group-id="8445711274-5">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="8445711274-6">{</span><span class="ss">:explorer</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.3.1&quot;</span><span class="p" data-group-id="8445711274-6">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="8445711274-7">{</span><span class="ss">:kino</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.7.0&quot;</span><span class="p" data-group-id="8445711274-7">}</span><span class="w">
</span><span class="p" data-group-id="8445711274-2">]</span><span class="p" data-group-id="8445711274-1">)</span><span class="w">

</span><span class="nc">Nx.Defn</span><span class="o">.</span><span class="n">default_options</span><span class="p" data-group-id="8445711274-8">(</span><span class="ss">compiler</span><span class="p">:</span><span class="w"> </span><span class="nc">EXLA</span><span class="p" data-group-id="8445711274-8">)</span><span class="w">
</span><span class="nc">Nx</span><span class="o">.</span><span class="n">global_default_backend</span><span class="p" data-group-id="8445711274-9">(</span><span class="nc">EXLA.Backend</span><span class="p" data-group-id="8445711274-9">)</span><span class="w">

</span><span class="kn">alias</span><span class="w"> </span><span class="nc">Explorer</span><span class="o">.</span><span class="p" data-group-id="8445711274-10">{</span><span class="nc">DataFrame</span><span class="p">,</span><span class="w"> </span><span class="nc">Series</span><span class="p" data-group-id="8445711274-10">}</span></code></pre><h2 id="introduction" class="section-heading">
  <a href="#introduction" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">introduction</p>
  </a>
  Introduction
</h2>
<p>This time we will examine the Credit Card Fraud Dataset. Due to confidentiality, the original data were preprocessed by principal component analysis (PCA), and then 31 principal components were selected for the final data set. The dataset is highly imbalanced. The positive class (frauds) account for 0.172% of all transactions. Eventually, we will create a classifier which has not only great accuracy but, what is even more important, a high <em>recall</em> and <em>precision</em> - two metrics that are much more indicative of performance with imbalanced classification problems.</p><h2 id="data-processing" class="section-heading">
  <a href="#data-processing" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">data-processing</p>
  </a>
  Data processing
</h2>
<p>The first step is to prepare the data for training and evaluation. Please download the dataset in the CSV format from <a href="https://www.kaggle.com/mlg-ulb/creditcardfraud">https://www.kaggle.com/mlg-ulb/creditcardfraud</a> (this requires a Kaggla account). Once done, put the file path in the input below.</p><pre><code class="makeup elixir" translate="no"><span class="n">data_path_input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Kino.Input</span><span class="o">.</span><span class="n">text</span><span class="p" data-group-id="3241939605-1">(</span><span class="s">&quot;Data path (CSV)&quot;</span><span class="p" data-group-id="3241939605-1">)</span></code></pre><p>Now, let's read the data into an <code class="inline">Explorer.Dataframe</code>:</p><pre><code class="makeup elixir" translate="no"><span class="n">data_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Kino.Input</span><span class="o">.</span><span class="n">read</span><span class="p" data-group-id="6785462550-1">(</span><span class="n">data_path_input</span><span class="p" data-group-id="6785462550-1">)</span><span class="w">

</span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">DataFrame</span><span class="o">.</span><span class="n">from_csv!</span><span class="p" data-group-id="6785462550-2">(</span><span class="n">data_path</span><span class="p">,</span><span class="w"> </span><span class="ss">dtypes</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="6785462550-3">[</span><span class="p" data-group-id="6785462550-4">{</span><span class="s">&quot;Time&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">:float</span><span class="p" data-group-id="6785462550-4">}</span><span class="p" data-group-id="6785462550-3">]</span><span class="p" data-group-id="6785462550-2">)</span></code></pre><p>For further processing, we will need a couple helper functions. We will group them in a module for convenience.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">CredidCard.Data</span><span class="w"> </span><span class="k" data-group-id="3972784458-1">do</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Nx.Defn</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">split_train_test</span><span class="p" data-group-id="3972784458-2">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="n">portion</span><span class="p" data-group-id="3972784458-2">)</span><span class="w"> </span><span class="k" data-group-id="3972784458-3">do</span><span class="w">
    </span><span class="n">num_examples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">DataFrame</span><span class="o">.</span><span class="n">n_rows</span><span class="p" data-group-id="3972784458-4">(</span><span class="n">df</span><span class="p" data-group-id="3972784458-4">)</span><span class="w">
    </span><span class="n">num_train</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ceil</span><span class="p" data-group-id="3972784458-5">(</span><span class="n">portion</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">num_examples</span><span class="p" data-group-id="3972784458-5">)</span><span class="w">
    </span><span class="n">num_test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num_examples</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">num_train</span><span class="w">

    </span><span class="n">train</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">DataFrame</span><span class="o">.</span><span class="n">slice</span><span class="p" data-group-id="3972784458-6">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">num_train</span><span class="p" data-group-id="3972784458-6">)</span><span class="w">
    </span><span class="n">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">DataFrame</span><span class="o">.</span><span class="n">slice</span><span class="p" data-group-id="3972784458-7">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="n">num_train</span><span class="p">,</span><span class="w"> </span><span class="n">num_test</span><span class="p" data-group-id="3972784458-7">)</span><span class="w">
    </span><span class="p" data-group-id="3972784458-8">{</span><span class="n">train</span><span class="p">,</span><span class="w"> </span><span class="n">test</span><span class="p" data-group-id="3972784458-8">}</span><span class="w">
  </span><span class="k" data-group-id="3972784458-3">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">split_features_targets</span><span class="p" data-group-id="3972784458-9">(</span><span class="n">df</span><span class="p" data-group-id="3972784458-9">)</span><span class="w"> </span><span class="k" data-group-id="3972784458-10">do</span><span class="w">
    </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">DataFrame</span><span class="o">.</span><span class="n">select</span><span class="p" data-group-id="3972784458-11">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p" data-group-id="3972784458-12">(</span><span class="ni">&amp;1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;Class&quot;</span><span class="p" data-group-id="3972784458-12">)</span><span class="p">,</span><span class="w"> </span><span class="ss">:drop</span><span class="p" data-group-id="3972784458-11">)</span><span class="w">
    </span><span class="n">targets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">DataFrame</span><span class="o">.</span><span class="n">select</span><span class="p" data-group-id="3972784458-13">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p" data-group-id="3972784458-14">(</span><span class="ni">&amp;1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;Class&quot;</span><span class="p" data-group-id="3972784458-14">)</span><span class="p">,</span><span class="w"> </span><span class="ss">:keep</span><span class="p" data-group-id="3972784458-13">)</span><span class="w">
    </span><span class="p" data-group-id="3972784458-15">{</span><span class="n">features</span><span class="p">,</span><span class="w"> </span><span class="n">targets</span><span class="p" data-group-id="3972784458-15">}</span><span class="w">
  </span><span class="k" data-group-id="3972784458-10">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">df_to_tensor</span><span class="p" data-group-id="3972784458-16">(</span><span class="n">df</span><span class="p" data-group-id="3972784458-16">)</span><span class="w"> </span><span class="k" data-group-id="3972784458-17">do</span><span class="w">
    </span><span class="n">df</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">DataFrame</span><span class="o">.</span><span class="n">names</span><span class="p" data-group-id="3972784458-18">(</span><span class="p" data-group-id="3972784458-18">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="3972784458-19">(</span><span class="o">&amp;</span><span class="nc">Series</span><span class="o">.</span><span class="n">to_tensor</span><span class="p" data-group-id="3972784458-20">(</span><span class="n">df</span><span class="p" data-group-id="3972784458-21">[</span><span class="ni">&amp;1</span><span class="p" data-group-id="3972784458-21">]</span><span class="p" data-group-id="3972784458-20">)</span><span class="p" data-group-id="3972784458-19">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">stack</span><span class="p" data-group-id="3972784458-22">(</span><span class="ss">axis</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="3972784458-22">)</span><span class="w">
  </span><span class="k" data-group-id="3972784458-17">end</span><span class="w">

  </span><span class="kd">defn</span><span class="w"> </span><span class="nf">normalize_features</span><span class="p" data-group-id="3972784458-23">(</span><span class="n">tensor</span><span class="p" data-group-id="3972784458-23">)</span><span class="w"> </span><span class="k" data-group-id="3972784458-24">do</span><span class="w">
    </span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="n">tensor</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">abs</span><span class="p" data-group-id="3972784458-25">(</span><span class="p" data-group-id="3972784458-25">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">reduce_max</span><span class="p" data-group-id="3972784458-26">(</span><span class="ss">axes</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3972784458-27">[</span><span class="mi">0</span><span class="p" data-group-id="3972784458-27">]</span><span class="p">,</span><span class="w"> </span><span class="ss">keep_axes</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="3972784458-26">)</span><span class="w">

    </span><span class="n">tensor</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">max</span><span class="w">
  </span><span class="k" data-group-id="3972784458-24">end</span><span class="w">
</span><span class="k" data-group-id="3972784458-1">end</span></code></pre><p>With that, we can start converting the data into the desired format. First, we split the data into training and test data (in proportion 80% into a training set and 20% into a test set).</p><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="9319463412-1">{</span><span class="n">train_df</span><span class="p">,</span><span class="w"> </span><span class="n">test_df</span><span class="p" data-group-id="9319463412-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CredidCard.Data</span><span class="o">.</span><span class="n">split_train_test</span><span class="p" data-group-id="9319463412-2">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="mf">0.8</span><span class="p" data-group-id="9319463412-2">)</span><span class="w">
</span><span class="p" data-group-id="9319463412-3">{</span><span class="nc">DataFrame</span><span class="o">.</span><span class="n">n_rows</span><span class="p" data-group-id="9319463412-4">(</span><span class="n">train_df</span><span class="p" data-group-id="9319463412-4">)</span><span class="p">,</span><span class="w"> </span><span class="nc">DataFrame</span><span class="o">.</span><span class="n">n_rows</span><span class="p" data-group-id="9319463412-5">(</span><span class="n">test_df</span><span class="p" data-group-id="9319463412-5">)</span><span class="p" data-group-id="9319463412-3">}</span></code></pre><p>Next, we separate features from labels and convert both to tensors. In case of features we additionally normalize each of them, dividing by the maximum absolute value of that feature.</p><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="7210347163-1">{</span><span class="n">train_features</span><span class="p">,</span><span class="w"> </span><span class="n">train_targets</span><span class="p" data-group-id="7210347163-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CredidCard.Data</span><span class="o">.</span><span class="n">split_features_targets</span><span class="p" data-group-id="7210347163-2">(</span><span class="n">train_df</span><span class="p" data-group-id="7210347163-2">)</span><span class="w">
</span><span class="p" data-group-id="7210347163-3">{</span><span class="n">test_features</span><span class="p">,</span><span class="w"> </span><span class="n">test_targets</span><span class="p" data-group-id="7210347163-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CredidCard.Data</span><span class="o">.</span><span class="n">split_features_targets</span><span class="p" data-group-id="7210347163-4">(</span><span class="n">test_df</span><span class="p" data-group-id="7210347163-4">)</span><span class="w">

</span><span class="n">train_inputs</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">train_features</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">CredidCard.Data</span><span class="o">.</span><span class="n">df_to_tensor</span><span class="p" data-group-id="7210347163-5">(</span><span class="p" data-group-id="7210347163-5">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">CredidCard.Data</span><span class="o">.</span><span class="n">normalize_features</span><span class="p" data-group-id="7210347163-6">(</span><span class="p" data-group-id="7210347163-6">)</span><span class="w">

</span><span class="n">test_inputs</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">test_features</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">CredidCard.Data</span><span class="o">.</span><span class="n">df_to_tensor</span><span class="p" data-group-id="7210347163-7">(</span><span class="p" data-group-id="7210347163-7">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">CredidCard.Data</span><span class="o">.</span><span class="n">normalize_features</span><span class="p" data-group-id="7210347163-8">(</span><span class="p" data-group-id="7210347163-8">)</span><span class="w">

</span><span class="n">train_targets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CredidCard.Data</span><span class="o">.</span><span class="n">df_to_tensor</span><span class="p" data-group-id="7210347163-9">(</span><span class="n">train_targets</span><span class="p" data-group-id="7210347163-9">)</span><span class="w">
</span><span class="n">test_targets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CredidCard.Data</span><span class="o">.</span><span class="n">df_to_tensor</span><span class="p" data-group-id="7210347163-10">(</span><span class="n">test_targets</span><span class="p" data-group-id="7210347163-10">)</span><span class="w">

</span><span class="ss">:ok</span></code></pre><h2 id="building-the-model" class="section-heading">
  <a href="#building-the-model" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">building-the-model</p>
  </a>
  Building the model
</h2>
<p>Our model for predicting whether a transaction was fraudulent or not is a dense neural network. It consists of two dense layers with 256 neurons, ReLU activation functions, one dropout layer, and a dense layer with one neuron (since the problem is a binary prediction) followed by a sigmoid activation function.</p><pre><code class="makeup elixir" translate="no"><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="nc">Axon</span><span class="o">.</span><span class="n">input</span><span class="p" data-group-id="1442671188-1">(</span><span class="s">&quot;input&quot;</span><span class="p" data-group-id="1442671188-1">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="1442671188-2">(</span><span class="mi">256</span><span class="p" data-group-id="1442671188-2">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">relu</span><span class="p" data-group-id="1442671188-3">(</span><span class="p" data-group-id="1442671188-3">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="1442671188-4">(</span><span class="mi">256</span><span class="p" data-group-id="1442671188-4">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">relu</span><span class="p" data-group-id="1442671188-5">(</span><span class="p" data-group-id="1442671188-5">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dropout</span><span class="p" data-group-id="1442671188-6">(</span><span class="ss">rate</span><span class="p">:</span><span class="w"> </span><span class="mf">0.3</span><span class="p" data-group-id="1442671188-6">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="1442671188-7">(</span><span class="mi">1</span><span class="p" data-group-id="1442671188-7">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">sigmoid</span><span class="p" data-group-id="1442671188-8">(</span><span class="p" data-group-id="1442671188-8">)</span></code></pre><h2 id="training-our-model" class="section-heading">
  <a href="#training-our-model" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">training-our-model</p>
  </a>
  Training our model
</h2>
<p>Now we have both data and model architecture prepared, it's time to train!</p><p>Note the disproportion in the data samples:</p><pre><code class="makeup elixir" translate="no"><span class="n">fraud</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">sum</span><span class="p" data-group-id="0975510635-1">(</span><span class="n">train_targets</span><span class="p" data-group-id="0975510635-1">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_number</span><span class="p" data-group-id="0975510635-2">(</span><span class="p" data-group-id="0975510635-2">)</span><span class="w">
</span><span class="n">legit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">size</span><span class="p" data-group-id="0975510635-3">(</span><span class="n">train_targets</span><span class="p" data-group-id="0975510635-3">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">fraud</span><span class="w">

</span><span class="n">batched_train_inputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_batched</span><span class="p" data-group-id="0975510635-4">(</span><span class="n">train_inputs</span><span class="p">,</span><span class="w"> </span><span class="mi">2048</span><span class="p" data-group-id="0975510635-4">)</span><span class="w">
</span><span class="n">batched_train_targets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_batched</span><span class="p" data-group-id="0975510635-5">(</span><span class="n">train_targets</span><span class="p">,</span><span class="w"> </span><span class="mi">2048</span><span class="p" data-group-id="0975510635-5">)</span><span class="w">
</span><span class="n">batched_train</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="o">.</span><span class="n">zip</span><span class="p" data-group-id="0975510635-6">(</span><span class="n">batched_train_inputs</span><span class="p">,</span><span class="w"> </span><span class="n">batched_train_targets</span><span class="p" data-group-id="0975510635-6">)</span><span class="w">

</span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="0975510635-7">(</span><span class="s">&quot;# of legit transactions (train): </span><span class="si" data-group-id="0975510635-8">#{</span><span class="n">legit</span><span class="si" data-group-id="0975510635-8">}</span><span class="s">&quot;</span><span class="p" data-group-id="0975510635-7">)</span><span class="w">
</span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="0975510635-9">(</span><span class="s">&quot;# of fraudulent transactions (train): </span><span class="si" data-group-id="0975510635-10">#{</span><span class="n">fraud</span><span class="si" data-group-id="0975510635-10">}</span><span class="s">&quot;</span><span class="p" data-group-id="0975510635-9">)</span><span class="w">
</span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="0975510635-11">(</span><span class="s">&quot;% fraudlent transactions (train): </span><span class="si" data-group-id="0975510635-12">#{</span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p" data-group-id="0975510635-13">(</span><span class="n">fraud</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p" data-group-id="0975510635-14">(</span><span class="n">legit</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fraud</span><span class="p" data-group-id="0975510635-14">)</span><span class="p" data-group-id="0975510635-13">)</span><span class="si" data-group-id="0975510635-12">}</span><span class="s">%&quot;</span><span class="p" data-group-id="0975510635-11">)</span></code></pre><p>As always, we define our train loop. We are using <em>binary cross-entropy</em> as our loss function and Adam as the optimizer with a learning rate of 0.01. Then we immediately start the training passing our train portion of the dataset.</p><pre><code class="makeup elixir" translate="no"><span class="n">loss</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="o">&amp;</span><span class="nc">Axon.Losses</span><span class="o">.</span><span class="n">binary_cross_entropy</span><span class="p" data-group-id="8934866658-1">(</span><span class="w">
    </span><span class="ni">&amp;1</span><span class="p">,</span><span class="w">
    </span><span class="ni">&amp;2</span><span class="p">,</span><span class="w">
    </span><span class="ss">negative_weight</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">legit</span><span class="p">,</span><span class="w">
    </span><span class="ss">positive_weight</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">fraud</span><span class="p">,</span><span class="w">
    </span><span class="ss">reduction</span><span class="p">:</span><span class="w"> </span><span class="ss">:mean</span><span class="w">
  </span><span class="p" data-group-id="8934866658-1">)</span><span class="w">

</span><span class="n">optimizer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Polaris.Optimizers</span><span class="o">.</span><span class="n">adam</span><span class="p" data-group-id="8934866658-2">(</span><span class="ss">learning_rate</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0e-2</span><span class="p" data-group-id="8934866658-2">)</span><span class="w">

</span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">model</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">trainer</span><span class="p" data-group-id="8934866658-3">(</span><span class="n">loss</span><span class="p">,</span><span class="w"> </span><span class="n">optimizer</span><span class="p" data-group-id="8934866658-3">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="8934866658-4">(</span><span class="n">batched_train</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8934866658-5">%{</span><span class="p" data-group-id="8934866658-5">}</span><span class="p">,</span><span class="w"> </span><span class="ss">epochs</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="ss">compiler</span><span class="p">:</span><span class="w"> </span><span class="nc">EXLA</span><span class="p" data-group-id="8934866658-4">)</span><span class="w">

</span><span class="ss">:ok</span></code></pre><h2 id="model-evaluation" class="section-heading">
  <a href="#model-evaluation" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">model-evaluation</p>
  </a>
  Model evaluation
</h2>
<p>After the training, there is only one thing left: testing. Here, we will focus on the number of true positive, true negative, false positive, and false negative values, but also on the likelihood of denying legit and fraudulent transactions.</p><pre><code class="makeup elixir" translate="no"><span class="n">batched_test_inputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_batched</span><span class="p" data-group-id="7406271668-1">(</span><span class="n">test_inputs</span><span class="p">,</span><span class="w"> </span><span class="mi">2048</span><span class="p" data-group-id="7406271668-1">)</span><span class="w">
</span><span class="n">batched_test_targets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_batched</span><span class="p" data-group-id="7406271668-2">(</span><span class="n">test_targets</span><span class="p">,</span><span class="w"> </span><span class="mi">2048</span><span class="p" data-group-id="7406271668-2">)</span><span class="w">
</span><span class="n">batched_test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="o">.</span><span class="n">zip</span><span class="p" data-group-id="7406271668-3">(</span><span class="n">batched_test_inputs</span><span class="p">,</span><span class="w"> </span><span class="n">batched_test_targets</span><span class="p" data-group-id="7406271668-3">)</span><span class="w">

</span><span class="n">summarize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="7406271668-4">fn</span><span class="w"> </span><span class="p" data-group-id="7406271668-5">%</span><span class="nc" data-group-id="7406271668-5">Axon.Loop.State</span><span class="p" data-group-id="7406271668-5">{</span><span class="ss">metrics</span><span class="p">:</span><span class="w"> </span><span class="n">metrics</span><span class="p" data-group-id="7406271668-5">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="n">legit_transactions_declined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_number</span><span class="p" data-group-id="7406271668-6">(</span><span class="n">metrics</span><span class="p" data-group-id="7406271668-7">[</span><span class="s">&quot;fp&quot;</span><span class="p" data-group-id="7406271668-7">]</span><span class="p" data-group-id="7406271668-6">)</span><span class="w">
  </span><span class="n">legit_transactions_accepted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_number</span><span class="p" data-group-id="7406271668-8">(</span><span class="n">metrics</span><span class="p" data-group-id="7406271668-9">[</span><span class="s">&quot;tn&quot;</span><span class="p" data-group-id="7406271668-9">]</span><span class="p" data-group-id="7406271668-8">)</span><span class="w">
  </span><span class="n">fraud_transactions_accepted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_number</span><span class="p" data-group-id="7406271668-10">(</span><span class="n">metrics</span><span class="p" data-group-id="7406271668-11">[</span><span class="s">&quot;fn&quot;</span><span class="p" data-group-id="7406271668-11">]</span><span class="p" data-group-id="7406271668-10">)</span><span class="w">
  </span><span class="n">fraud_transactions_declined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_number</span><span class="p" data-group-id="7406271668-12">(</span><span class="n">metrics</span><span class="p" data-group-id="7406271668-13">[</span><span class="s">&quot;tp&quot;</span><span class="p" data-group-id="7406271668-13">]</span><span class="p" data-group-id="7406271668-12">)</span><span class="w">
  </span><span class="n">total_fraud</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fraud_transactions_declined</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fraud_transactions_accepted</span><span class="w">
  </span><span class="n">total_legit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">legit_transactions_declined</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">legit_transactions_accepted</span><span class="w">

  </span><span class="n">fraud_denial_percent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p" data-group-id="7406271668-14">(</span><span class="n">fraud_transactions_declined</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">total_fraud</span><span class="p" data-group-id="7406271668-14">)</span><span class="w">
  </span><span class="n">legit_denial_percent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p" data-group-id="7406271668-15">(</span><span class="n">legit_transactions_declined</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">total_legit</span><span class="p" data-group-id="7406271668-15">)</span><span class="w">

  </span><span class="nc">IO</span><span class="o">.</span><span class="n">write</span><span class="p" data-group-id="7406271668-16">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p" data-group-id="7406271668-16">)</span><span class="w">
  </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="7406271668-17">(</span><span class="s">&quot;Legit Transactions Declined: </span><span class="si" data-group-id="7406271668-18">#{</span><span class="n">legit_transactions_declined</span><span class="si" data-group-id="7406271668-18">}</span><span class="s">&quot;</span><span class="p" data-group-id="7406271668-17">)</span><span class="w">
  </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="7406271668-19">(</span><span class="s">&quot;Fraudulent Transactions Caught: </span><span class="si" data-group-id="7406271668-20">#{</span><span class="n">fraud_transactions_declined</span><span class="si" data-group-id="7406271668-20">}</span><span class="s">&quot;</span><span class="p" data-group-id="7406271668-19">)</span><span class="w">
  </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="7406271668-21">(</span><span class="s">&quot;Fraudulent Transactions Missed: </span><span class="si" data-group-id="7406271668-22">#{</span><span class="n">fraud_transactions_accepted</span><span class="si" data-group-id="7406271668-22">}</span><span class="s">&quot;</span><span class="p" data-group-id="7406271668-21">)</span><span class="w">
  </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="7406271668-23">(</span><span class="s">&quot;Likelihood of catching fraud: </span><span class="si" data-group-id="7406271668-24">#{</span><span class="n">fraud_denial_percent</span><span class="si" data-group-id="7406271668-24">}</span><span class="s">%&quot;</span><span class="p" data-group-id="7406271668-23">)</span><span class="w">
  </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="7406271668-25">(</span><span class="s">&quot;Likelihood of denying legit transaction: </span><span class="si" data-group-id="7406271668-26">#{</span><span class="n">legit_denial_percent</span><span class="si" data-group-id="7406271668-26">}</span><span class="s">%&quot;</span><span class="p" data-group-id="7406271668-25">)</span><span class="w">

  </span><span class="p" data-group-id="7406271668-27">{</span><span class="ss">:continue</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="7406271668-27">}</span><span class="w">
</span><span class="k" data-group-id="7406271668-4">end</span><span class="w">

</span><span class="n">model</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">evaluator</span><span class="p" data-group-id="7406271668-28">(</span><span class="p" data-group-id="7406271668-28">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">metric</span><span class="p" data-group-id="7406271668-29">(</span><span class="ss">:true_positives</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tp&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">:running_sum</span><span class="p" data-group-id="7406271668-29">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">metric</span><span class="p" data-group-id="7406271668-30">(</span><span class="ss">:true_negatives</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tn&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">:running_sum</span><span class="p" data-group-id="7406271668-30">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">metric</span><span class="p" data-group-id="7406271668-31">(</span><span class="ss">:false_positives</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fp&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">:running_sum</span><span class="p" data-group-id="7406271668-31">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">metric</span><span class="p" data-group-id="7406271668-32">(</span><span class="ss">:false_negatives</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fn&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">:running_sum</span><span class="p" data-group-id="7406271668-32">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">handle</span><span class="p" data-group-id="7406271668-33">(</span><span class="ss">:epoch_completed</span><span class="p">,</span><span class="w"> </span><span class="n">summarize</span><span class="p" data-group-id="7406271668-33">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="7406271668-34">(</span><span class="n">batched_test</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="ss">compiler</span><span class="p">:</span><span class="w"> </span><span class="nc">EXLA</span><span class="p" data-group-id="7406271668-34">)</span><span class="w">

</span><span class="ss">:ok</span></code></pre>
<div class="bottom-actions">
  <div class="bottom-actions-item">

      <a href="lstm_generation.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Generating text with LSTM
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="mnist_autoencoder_using_kino.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
MNIST Denoising Autoencoder using Kino for visualization
        </span>
      </a>

  </div>
</div>
      <footer class="footer">
        <p>

            <span class="line">
              <a href="https://hex.pm/packages/axon/0.6.0" class="footer-hex-package">Hex Package</a>

              <a href="https://preview.hex.pm/preview/axon/0.6.0">Hex Preview</a>

                (<a href="https://preview.hex.pm/preview/axon/0.6.0/show/notebooks/structured/credit_card_fraud.livemd">current file</a>)

            </span>

          <span class="line">
            <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
              Search HexDocs
            </button>

              <a href="Axon.epub" title="ePub version">
                Download ePub version
              </a>

          </span>
        </p>

        <p class="built-using">
          Built using
          <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.29.3) for the

            <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

        </p>
      </footer>
    </div>
  </div>
</section>
</div>

<!-- Render math with KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css" integrity="sha384-t5CR+zwDAROtph0PXGte6ia8heboACF9R5l/DiY+WZ3P2lxNgvJkQk5n7GPvLMYw" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.js" integrity="sha384-FaFLTlohFghEIZkw6VGwmf9ISTubWAVYW8tG8+w2LAIftJEULZABrF9PPFv+tVkH" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/auto-render.min.js" integrity="sha384-bHBqxz8fokvgoJ/sc17HODNxa42TlaEhB+w8ZJXTc2nZf1VgEaFZeZvT4Mznfz0v" crossorigin="anonymous"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
      ]
    });
  });
</script>

<!-- Render diagrams with Mermaid -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@8.13.3/dist/mermaid.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    mermaid.initialize({ startOnLoad: false });
    let id = 0;
    for (const codeEl of document.querySelectorAll("pre code.mermaid")) {
      const preEl = codeEl.parentElement;
      const graphDefinition = codeEl.textContent;
      const graphEl = document.createElement("div");
      const graphId = "mermaid-graph-" + id++;
      mermaid.render(graphId, graphDefinition, function (svgSource, bindListeners) {
        graphEl.innerHTML = svgSource;
        bindListeners && bindListeners(graphEl);
        preEl.insertAdjacentElement("afterend", graphEl);
        preEl.remove();
      });
    }
  });
</script>

  </body>
</html>
